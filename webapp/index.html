<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>AdaptLink Support Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        color-scheme: dark;
        --bg: #090f1d;
        --bg-soft: #0d1629;
        --panel: rgba(21, 32, 53, 0.45);
        --surface: rgba(28, 42, 68, 0.46);
        --surface-2: rgba(36, 54, 84, 0.44);
        --text: #edf3ff;
        --muted: #a7bad8;
        --line: rgba(178, 206, 255, 0.24);
        --accent: #61ddff;
        --accent-2: #6aaeff;
        --danger: #f87171;
        --success: #34d399;
        --shadow: 0 16px 44px rgba(2, 8, 21, 0.52);
        --input: rgba(20, 33, 56, 0.42);
        --dock: rgba(18, 30, 50, 0.62);
        --glass-blur: 22px;
        --glass-sat: 160%;
        --highlight: rgba(255, 255, 255, 0.32);
      }

      html[data-theme="light"] {
        color-scheme: light;
        --bg: #f0f4fb;
        --bg-soft: #f6f8fc;
        --panel: rgba(255, 255, 255, 0.56);
        --surface: rgba(248, 250, 255, 0.66);
        --surface-2: rgba(244, 247, 255, 0.72);
        --text: #1e2b3f;
        --muted: #6b7f9d;
        --line: rgba(47, 77, 129, 0.16);
        --accent: #1dc3ff;
        --accent-2: #3f8dff;
        --danger: #ef4444;
        --success: #22c55e;
        --shadow: 0 12px 28px rgba(37, 60, 101, 0.12);
        --input: rgba(255, 255, 255, 0.74);
        --dock: rgba(255, 255, 255, 0.7);
        --glass-blur: 16px;
        --glass-sat: 145%;
        --highlight: rgba(255, 255, 255, 0.72);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background:
          radial-gradient(900px 500px at -8% -8%, rgba(98, 172, 255, 0.34), transparent 50%),
          radial-gradient(840px 460px at 112% 2%, rgba(89, 224, 255, 0.32), transparent 50%),
          radial-gradient(700px 480px at 50% 120%, rgba(73, 131, 255, 0.25), transparent 54%),
          linear-gradient(180deg, var(--bg-soft) 0%, var(--bg) 100%);
        color: var(--text);
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(
              1200px 400px at 50% -150px,
              rgba(255, 255, 255, 0.14),
              transparent 62%
            )
            no-repeat,
          radial-gradient(900px 300px at 50% 110%, rgba(255, 255, 255, 0.1), transparent 66%)
            no-repeat;
        mix-blend-mode: screen;
        z-index: 0;
      }

      body.no-scroll {
        overflow: hidden;
      }

      .app {
        width: min(100%, 460px);
        margin: 0 auto;
        padding: 16px 14px calc(92px + env(safe-area-inset-bottom, 0px));
        display: grid;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .card {
        background: linear-gradient(180deg, var(--panel), var(--surface));
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 14px;
        box-shadow: var(--shadow);
        backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
        -webkit-backdrop-filter: saturate(var(--glass-sat)) blur(var(--glass-blur));
        position: relative;
        overflow: hidden;
      }

      .card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 40%;
        background: linear-gradient(180deg, var(--highlight), transparent);
        opacity: 0.24;
        pointer-events: none;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .brand {
        display: grid;
        gap: 4px;
      }

      .brand-title {
        margin: 0;
        font-size: 28px;
        line-height: 1;
        letter-spacing: -0.03em;
      }

      .brand-sub {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pill {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 12px;
        color: var(--muted);
        background: var(--surface-2);
        backdrop-filter: saturate(var(--glass-sat)) blur(8px);
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: 1px solid rgba(82, 209, 255, 0.45);
        background: linear-gradient(180deg, rgba(82, 209, 255, 0.28), rgba(63, 141, 255, 0.2));
        display: grid;
        place-items: center;
        font-size: 14px;
        font-weight: 700;
      }

      .icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--surface-2);
        color: var(--muted);
        display: grid;
        place-items: center;
        cursor: pointer;
      }

      .icon-btn svg {
        width: 17px;
        height: 17px;
        stroke: currentColor;
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      .kpi {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: var(--surface-2);
        padding: 10px;
      }

      .kpi-head {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      .kpi-dot {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        background: rgba(82, 209, 255, 0.2);
        display: grid;
        place-items: center;
        color: var(--accent);
      }

      .kpi-dot svg {
        width: 13px;
        height: 13px;
        stroke: currentColor;
      }

      .kpi-value {
        margin-top: 8px;
        font-size: 32px;
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .field,
      .btn,
      .seg-btn {
        width: 100%;
        font: inherit;
        border-radius: 14px;
        border: 1px solid var(--line);
      }

      .field {
        background: var(--input);
        color: var(--text);
        padding: 12px 13px;
        backdrop-filter: saturate(140%) blur(10px);
      }

      .field::placeholder {
        color: var(--muted);
      }

      textarea.field {
        min-height: 110px;
        resize: vertical;
      }

      .btn {
        background: var(--surface-2);
        color: var(--text);
        padding: 10px 12px;
        cursor: pointer;
        backdrop-filter: saturate(130%) blur(8px);
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      .btn-primary {
        border: none;
        background: linear-gradient(140deg, var(--accent), var(--accent-2));
        color: #fff;
        font-weight: 700;
        box-shadow: 0 10px 22px rgba(82, 209, 255, 0.34);
      }

      .btn-danger {
        border: none;
        background: var(--danger);
        color: #fff;
      }

      .btn-success {
        border: none;
        background: var(--success);
        color: #032214;
        font-weight: 700;
      }

      .stack {
        display: grid;
        gap: 10px;
      }

      .section-title {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .item {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--surface-2);
        padding: 10px;
        display: grid;
        gap: 8px;
        backdrop-filter: saturate(var(--glass-sat)) blur(12px);
      }

      .users-list {
        display: grid;
        gap: 8px;
        max-height: 260px;
        overflow: auto;
      }

      .user-row {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 8px 10px;
        background: var(--panel);
      }

      .user-meta {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .spaced {
        justify-content: space-between;
      }

      .muted {
        color: var(--muted);
      }

      .status-chip {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 700;
        border: 1px solid transparent;
      }

      .status-chip.new {
        background: rgba(82, 209, 255, 0.2);
        border-color: rgba(82, 209, 255, 0.4);
        color: var(--accent);
      }

      .status-chip.in-progress {
        background: rgba(250, 204, 21, 0.16);
        border-color: rgba(250, 204, 21, 0.32);
        color: #ffd666;
      }

      .status-chip.completed {
        background: rgba(52, 211, 153, 0.16);
        border-color: rgba(52, 211, 153, 0.34);
        color: #7cf2cc;
      }

      html[data-theme="light"] .status-chip.in-progress {
        color: #8c6700;
      }

      html[data-theme="light"] .status-chip.completed {
        color: #0f7a55;
      }

      .segmented {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 7px;
      }

      .seg-btn {
        background: var(--surface-2);
        color: var(--muted);
        padding: 9px 6px;
        cursor: pointer;
      }

      .seg-btn.active {
        border-color: rgba(82, 209, 255, 0.45);
        background: rgba(82, 209, 255, 0.18);
        color: var(--accent);
        font-weight: 700;
      }

      #status {
        margin: 0;
        min-height: 20px;
      }

      .bottom-nav {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: calc(9px + env(safe-area-inset-bottom, 0px));
        width: min(100vw - 12px, 440px);
        border: 1px solid var(--line);
        border-radius: 18px;
        background: var(--dock);
        padding: 7px;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        z-index: 30;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px) saturate(160%);
        box-shadow: 0 12px 28px rgba(8, 14, 29, 0.32);
      }

      .bottom-tab {
        border: none;
        border-radius: 12px;
        background: transparent;
        color: var(--muted);
        display: grid;
        justify-items: center;
        gap: 3px;
        padding: 6px 4px;
        cursor: pointer;
      }

      .bottom-tab.active {
        color: var(--accent);
        background: rgba(82, 209, 255, 0.16);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.25);
      }

      .bottom-tab-icon svg {
        width: 19px;
        height: 19px;
        stroke: currentColor;
      }

      .bottom-tab-label {
        font-size: 10px;
      }

      .chat-overlay {
        position: fixed;
        inset: 0;
        z-index: 60;
        width: min(100vw, 460px);
        margin: 0 auto;
        background: linear-gradient(180deg, var(--bg-soft) 0%, var(--bg) 100%);
        display: grid;
        grid-template-rows: auto 1fr auto;
      }

      .chat-header {
        padding: 12px;
        border-bottom: 1px solid var(--line);
        background: var(--panel);
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: saturate(var(--glass-sat)) blur(14px);
      }

      .chat-head-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chat-body {
        padding: 12px;
        overflow-y: auto;
        display: grid;
        gap: 10px;
      }

      .chat-msg-row {
        display: flex;
        gap: 8px;
      }

      .chat-msg-row.outgoing {
        justify-content: flex-end;
      }

      .chat-msg {
        max-width: 84%;
        border-radius: 14px;
        padding: 9px 11px;
        border: 1px solid var(--line);
        background: var(--panel);
        backdrop-filter: saturate(140%) blur(8px);
      }

      .chat-msg.outgoing {
        border-color: rgba(82, 209, 255, 0.45);
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff;
      }

      .chat-msg.outgoing .muted {
        color: rgba(255, 255, 255, 0.86);
      }

      .chat-avatar {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        flex-shrink: 0;
        display: grid;
        place-items: center;
        font-size: 8px;
        font-weight: 700;
        color: #fff;
        background: radial-gradient(circle at 35% 35%, #7de3ff 0%, #47c7ff 45%, #2a6de0 100%);
      }

      .chat-footer {
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
        border-top: 1px solid var(--line);
        background: var(--panel);
        backdrop-filter: blur(14px);
      }

      .chat-input-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: center;
      }

      .chat-send {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff;
        cursor: pointer;
      }

      .chat-send svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 390px) {
        .brand-title {
          font-size: 23px;
        }

        .app {
          padding: 12px 10px calc(88px + env(safe-area-inset-bottom, 0px));
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="card">
        <div class="header">
          <div class="brand">
            <h1 class="brand-title">AdaptLink Support</h1>
            <p class="brand-sub" id="whoami">Загрузка профиля...</p>
          </div>
          <div class="header-controls">
            <button id="theme-toggle" class="icon-btn" type="button" aria-label="Сменить тему"></button>
            <span class="pill" id="role-badge">-</span>
            <span class="avatar" id="profile-dot">A</span>
          </div>
        </div>
      </section>

      <section id="register-card" class="card hidden">
        <h2 class="section-title">Регистрация</h2>
        <div class="stack">
          <input id="reg-name" class="field" placeholder="ФИО" />
          <input id="reg-org" class="field" placeholder="Организация" />
          <button id="register-btn" class="btn btn-primary">Зарегистрироваться</button>
        </div>
      </section>

      <section id="main-card" class="card hidden">
        <div id="content"></div>
      </section>

      <section class="card">
        <p id="status" class="muted">Готово.</p>
      </section>
    </main>

    <nav id="tabs" class="bottom-nav hidden"></nav>

    <section id="chat-card" class="chat-overlay hidden">
      <div class="chat-header">
        <div class="chat-head-left">
          <button id="chat-back" class="icon-btn" type="button" aria-label="Назад"></button>
          <strong id="chat-title">Заявка #0</strong>
        </div>
        <span id="chat-status" class="status-chip in-progress">IN_PROGRESS</span>
      </div>
      <div id="chat-messages" class="chat-body"></div>
      <div class="chat-footer">
        <div class="chat-input-row">
          <button id="chat-attach" class="icon-btn" type="button" aria-label="Прикрепить"></button>
          <input id="chat-input" class="field" placeholder="Введите сообщение..." />
          <button id="chat-send" class="chat-send" type="button" aria-label="Отправить"></button>
        </div>
      </div>
    </section>

    <script>
      const ICONS = {
        sun:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v3M12 19v3M4.9 4.9l2.2 2.2M16.9 16.9l2.2 2.2M2 12h3M19 12h3M4.9 19.1l2.2-2.2M16.9 7.1l2.2-2.2"/></svg>',
        moon:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 12.8A9 9 0 1 1 11.2 3a7.2 7.2 0 0 0 9.8 9.8z"/></svg>',
        home:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 11.5L12 4l9 7.5"/><path d="M6.5 10.5V20h11V10.5"/></svg>',
        requests:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>',
        profile:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="8" r="3.5"/><path d="M5 20c1.8-3 4-4.5 7-4.5s5.2 1.5 7 4.5"/></svg>',
        folder:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 7h6l2 2h10v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',
        bolt:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M13 2 5 13h6l-1 9 9-12h-6z"/></svg>',
        back:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>',
        attach:
          '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21.4 11.1 13 19.5a5 5 0 0 1-7.1-7.1l9.2-9.2a3.5 3.5 0 0 1 5 5l-9.2 9.2a2 2 0 0 1-2.8-2.8l8.5-8.5"/></svg>',
        send:
          '<svg viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22l-4-9-9-4z" fill="none" stroke="currentColor" stroke-width="2"/></svg>'
      };

      const tg = window.Telegram?.WebApp || null;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      const params = new URLSearchParams(location.search);
      const apiBase = (params.get("api") || "").replace(/\/+$/, "");
      const tgUser = tg?.initDataUnsafe?.user || null;
      const fallbackTelegramId = Number(params.get("telegramId")) || null;
      const telegramId = tgUser?.id || fallbackTelegramId;

      const whoamiEl = document.getElementById("whoami");
      const roleBadgeEl = document.getElementById("role-badge");
      const profileDotEl = document.getElementById("profile-dot");
      const statusEl = document.getElementById("status");
      const registerCard = document.getElementById("register-card");
      const mainCard = document.getElementById("main-card");
      const contentEl = document.getElementById("content");
      const tabsEl = document.getElementById("tabs");
      const chatCard = document.getElementById("chat-card");
      const chatTitle = document.getElementById("chat-title");
      const chatStatus = document.getElementById("chat-status");
      const chatMessages = document.getElementById("chat-messages");
      const chatInput = document.getElementById("chat-input");
      const themeToggleEl = document.getElementById("theme-toggle");
      const chatBackEl = document.getElementById("chat-back");
      const chatAttachEl = document.getElementById("chat-attach");
      const chatSendEl = document.getElementById("chat-send");

      chatBackEl.innerHTML = ICONS.back;
      chatAttachEl.innerHTML = ICONS.attach;
      chatSendEl.innerHTML = ICONS.send;

      const tabIcons = {
        home: ICONS.home,
        requests: ICONS.requests,
        profile: ICONS.profile
      };

      const state = {
        bootstrap: null,
        activeTab: "",
        activeChatRequestId: null,
        adminRequestFilter: "new",
        chatPollTimer: null
      };

      const THEME_STORAGE_KEY = "adaptlink-miniapp-theme";

      function escapeHtml(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDate(value) {
        try {
          return new Date(value).toLocaleString();
        } catch {
          return value;
        }
      }

      function statusChipClass(status) {
        if (status === "IN_PROGRESS") return "in-progress";
        if (status === "COMPLETED") return "completed";
        return "new";
      }

      function statusLabel(status) {
        if (status === "IN_PROGRESS") return "В РАБОТЕ";
        if (status === "COMPLETED") return "ЗАВЕРШЕНО";
        return "НОВАЯ";
      }

      function setStatus(message) {
        statusEl.textContent = message;
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        themeToggleEl.innerHTML = theme === "dark" ? ICONS.moon : ICONS.sun;
        themeToggleEl.title = theme === "dark" ? "Тёмная тема" : "Светлая тема";
        if (tg && typeof tg.setHeaderColor === "function") {
          tg.setHeaderColor(theme === "dark" ? "#141f35" : "#ffffff");
        }
      }

      function initTheme() {
        const saved = localStorage.getItem(THEME_STORAGE_KEY);
        const initial = saved || (tg?.colorScheme === "light" ? "light" : "dark");
        applyTheme(initial);
      }

      async function api(path, options = {}) {
        if (!apiBase) {
          throw new Error("API URL не задан. Откройте Mini App через кнопку бота.");
        }

        const response = await fetch(`${apiBase}${path}`, {
          method: options.method || "GET",
          headers: {
            "Content-Type": "application/json",
            "x-telegram-id": String(telegramId)
          },
          body: options.body ? JSON.stringify(options.body) : undefined
        });

        if (!response.ok) {
          const body = await response.json().catch(() => ({}));
          throw new Error(body.error || `HTTP ${response.status}`);
        }
        return response.json();
      }

      function renderTabs(tabs) {
        tabsEl.innerHTML = "";
        tabs.forEach((tab) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `bottom-tab ${state.activeTab === tab.id ? "active" : ""}`;
          button.innerHTML = `
            <span class="bottom-tab-icon">${tabIcons[tab.id] || ""}</span>
            <span class="bottom-tab-label">${escapeHtml(tab.title)}</span>
          `;
          button.onclick = () => {
            state.activeTab = tab.id;
            renderApp();
          };
          tabsEl.appendChild(button);
        });
      }

      function renderUserView() {
        const payload = state.bootstrap;
        const tabs = [
          { id: "home", title: "Главная" },
          { id: "requests", title: "Заявки" },
          { id: "profile", title: "Профиль" }
        ];
        if (!state.activeTab) state.activeTab = "home";
        renderTabs(tabs);

        if (state.activeTab === "home") {
          const recent = (payload.requests || []).slice(0, 3);
          contentEl.innerHTML = `
            <div class="stack">
              <button id="scroll-to-form" class="btn btn-primary">Новая заявка</button>
              <div class="kpis">
                <div class="kpi">
                  <div class="kpi-head"><span class="kpi-dot">${ICONS.folder}</span>Открытые заявки</div>
                  <div class="kpi-value">${payload.stats?.open || 0}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-head"><span class="kpi-dot">${ICONS.bolt}</span>В работе</div>
                  <div class="kpi-value">${payload.stats?.inProgress || 0}</div>
                </div>
              </div>
              <div class="item" id="request-form-block">
                <h3 class="section-title">Новая заявка</h3>
                <input id="request-topic" class="field" placeholder="Тема" />
                <textarea id="request-description" class="field" placeholder="Описание"></textarea>
                <select id="request-priority" class="field">
                  <option value="Низкий">Низкий</option>
                  <option value="Средний" selected>Средний</option>
                  <option value="Высокий">Высокий</option>
                </select>
                <button id="request-submit" class="btn btn-primary">Отправить заявку</button>
              </div>
              <div class="item">
                <h3 class="section-title">Активность</h3>
                ${
                  recent.length
                    ? recent
                        .map(
                          (request) => `
                            <div class="row spaced">
                              <span>#${request.id}</span>
                              <span class="status-chip ${statusChipClass(request.status)}">${statusLabel(request.status)}</span>
                            </div>
                          `
                        )
                        .join("")
                    : `<p class="muted" style="margin:0">Пока нет активности.</p>`
                }
              </div>
            </div>
          `;

          document.getElementById("scroll-to-form").onclick = () => {
            document.getElementById("request-form-block").scrollIntoView({ behavior: "smooth" });
          };

          document.getElementById("request-submit").onclick = async () => {
            const topic = document.getElementById("request-topic").value.trim();
            const description = document.getElementById("request-description").value.trim();
            const priority = document.getElementById("request-priority").value;
            if (!topic || !description) return setStatus("Заполните тему и описание заявки.");

            const text = [`Тема: ${topic}`, `Приоритет: ${priority}`, "", description].join("\n");
            await api("/api/requests", { method: "POST", body: { text } });
            setStatus("Заявка отправлена.");
            await loadBootstrap();
          };
          return;
        }

        if (state.activeTab === "requests") {
          const rows = (payload.requests || [])
            .map(
              (request) => `
                <div class="item">
                  <div class="row spaced">
                    <strong>#${request.id}</strong>
                    <span class="status-chip ${statusChipClass(request.status)}">${statusLabel(request.status)}</span>
                  </div>
                  <div>${escapeHtml(request.text)}</div>
                  <div class="muted">${formatDate(request.createdAt)}</div>
                  ${
                    request.status === "IN_PROGRESS"
                      ? `<button class="btn btn-primary" data-open-chat="${request.id}">Открыть диалог</button>`
                      : ""
                  }
                </div>
              `
            )
            .join("");
          contentEl.innerHTML = `<div class="stack">${rows || `<p class="muted">Пока нет заявок.</p>`}</div>`;
          contentEl.querySelectorAll("[data-open-chat]").forEach((button) => {
            button.onclick = () => openChat(Number(button.dataset.openChat));
          });
          return;
        }

        const links = (payload.instructions || [])
          .map(
            (item) =>
              `<button class="btn" data-open-instruction="${item.url}" style="text-align:left">${escapeHtml(item.title)}</button>`
          )
          .join("");

        contentEl.innerHTML = `
          <div class="stack">
            <div class="item">
              <h3 class="section-title">Профиль</h3>
              <div class="muted">Роль: Пользователь</div>
              <div class="muted">ID: ${payload.user?.telegramId || "-"}</div>
            </div>
            <div class="item">
              <h3 class="section-title">Предложения по доработке</h3>
              <textarea id="suggestion-text" class="field" placeholder="Опишите вашу идею"></textarea>
              <button id="suggestion-submit" class="btn btn-primary">Отправить предложение</button>
            </div>
            <div class="item">
              <h3 class="section-title">Инструкции</h3>
              ${links || `<p class="muted">Инструкции недоступны.</p>`}
            </div>
          </div>
        `;

        document.getElementById("suggestion-submit").onclick = async () => {
          const text = document.getElementById("suggestion-text").value.trim();
          if (!text) return setStatus("Заполните текст предложения.");
          await api("/api/suggestions", { method: "POST", body: { text } });
          setStatus("Предложение отправлено.");
        };

        contentEl.querySelectorAll("[data-open-instruction]").forEach((button) => {
          button.onclick = () => window.open(`${apiBase}${button.dataset.openInstruction}`, "_blank");
        });
      }

      function renderAdminView() {
        const payload = state.bootstrap;
        const tabs = [
          { id: "home", title: "Главная" },
          { id: "requests", title: "Заявки" },
          { id: "profile", title: "Профиль" }
        ];
        if (!state.activeTab) state.activeTab = "home";
        renderTabs(tabs);

        const requestsMap = {
          new: payload.requests?.new || [],
          inprogress: payload.requests?.inProgress || [],
          completed: payload.requests?.completed || []
        };

        if (state.activeTab === "home") {
          contentEl.innerHTML = `
            <div class="stack">
              <div class="kpis">
                <div class="kpi">
                  <div class="kpi-head"><span class="kpi-dot">${ICONS.folder}</span>Новые</div>
                  <div class="kpi-value">${requestsMap.new.length}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-head"><span class="kpi-dot">${ICONS.bolt}</span>В работе</div>
                  <div class="kpi-value">${requestsMap.inprogress.length}</div>
                </div>
              </div>
              <button id="open-admin-requests" class="btn btn-primary">Перейти к заявкам</button>
            </div>
          `;
          document.getElementById("open-admin-requests").onclick = () => {
            state.activeTab = "requests";
            renderApp();
          };
          return;
        }

        if (state.activeTab === "requests") {
          const filter = state.adminRequestFilter || "new";
          const list = requestsMap[filter]
            .map(
              (request) => `
                <div class="item">
                  <div class="row spaced">
                    <strong>#${request.id}</strong>
                    <span class="status-chip ${statusChipClass(request.status)}">${statusLabel(request.status)}</span>
                  </div>
                  <div>${escapeHtml(request.text)}</div>
                  <div class="muted">Пользователь: ${request.userTelegramId}</div>
                  <div class="row">
                    ${
                      request.status === "NEW"
                        ? `<button class="btn btn-success" data-take="${request.id}">Принять</button>`
                        : ""
                    }
                    ${
                      request.status === "IN_PROGRESS"
                        ? `<button class="btn btn-primary" data-open-chat="${request.id}">Диалог</button>
                           <button class="btn btn-danger" data-finish="${request.id}">Завершить</button>`
                        : ""
                    }
                  </div>
                </div>
              `
            )
            .join("");

          contentEl.innerHTML = `
            <div class="stack">
              <div class="segmented">
                <button class="seg-btn ${filter === "new" ? "active" : ""}" data-filter="new">Новые</button>
                <button class="seg-btn ${filter === "inprogress" ? "active" : ""}" data-filter="inprogress">В работе</button>
                <button class="seg-btn ${filter === "completed" ? "active" : ""}" data-filter="completed">Завершенные</button>
              </div>
              ${list || `<p class="muted">Пусто.</p>`}
            </div>
          `;

          contentEl.querySelectorAll("[data-filter]").forEach((button) => {
            button.onclick = () => {
              state.adminRequestFilter = button.dataset.filter;
              renderAdminView();
            };
          });

          contentEl.querySelectorAll("[data-take]").forEach((button) => {
            button.onclick = async () => {
              await api(`/api/requests/${button.dataset.take}/take`, { method: "POST" });
              setStatus(`Заявка #${button.dataset.take} взята в работу.`);
              await loadBootstrap();
            };
          });

          contentEl.querySelectorAll("[data-finish]").forEach((button) => {
            button.onclick = async () => {
              await api(`/api/requests/${button.dataset.finish}/finish`, { method: "POST" });
              setStatus(`Заявка #${button.dataset.finish} завершена.`);
              await loadBootstrap();
            };
          });

          contentEl.querySelectorAll("[data-open-chat]").forEach((button) => {
            button.onclick = () => openChat(Number(button.dataset.openChat));
          });
          return;
        }

        const rows = (payload.suggestions || [])
          .map(
            (item) => `
              <div class="item">
                <strong>#${item.id}</strong>
                <div>${escapeHtml(item.text)}</div>
                <div class="muted">${escapeHtml(item.fullName || "не указано")} | ${escapeHtml(
                  item.organization || "не указана"
                )}</div>
              </div>
            `
          )
          .join("");
        const links = (payload.instructions || [])
          .map(
            (item) =>
              `<button class="btn" data-open-instruction="${item.url}" style="text-align:left">${escapeHtml(item.title)}</button>`
          )
          .join("");
        const users = (payload.users || [])
          .map((item) => {
            const displayName =
              item.fullName ||
              [item.firstName, item.lastName].filter(Boolean).join(" ").trim() ||
              item.username ||
              `ID ${item.telegramId}`;
            const username = item.username ? `@${item.username}` : "нет username";
            const organization = item.organization || "организация не указана";
            return `
              <div class="user-row">
                <div class="row spaced">
                  <strong>${escapeHtml(displayName)}</strong>
                  <span class="status-chip ${item.role === "ADMIN" ? "in-progress" : "new"}">${escapeHtml(item.role)}</span>
                </div>
                <div class="user-meta">ID: ${item.telegramId} | ${escapeHtml(username)}</div>
                <div class="user-meta">${escapeHtml(organization)}</div>
              </div>
            `;
          })
          .join("");

        contentEl.innerHTML = `
          <div class="stack">
            <div class="item">
              <h3 class="section-title">Профиль администратора</h3>
              <div class="muted">Роль: Администратор</div>
              <div class="muted">ID: ${payload.user?.telegramId || "-"}</div>
            </div>
            <div class="item">
              <h3 class="section-title">Зарегистрированные пользователи</h3>
              <div class="users-list">
                ${users || `<p class="muted">Пользователи пока не зарегистрированы.</p>`}
              </div>
            </div>
            <div class="item">
              <h3 class="section-title">Предложения</h3>
              ${rows || `<p class="muted">Пока нет предложений.</p>`}
            </div>
            <div class="item">
              <h3 class="section-title">Инструкции</h3>
              ${links || `<p class="muted">Инструкции недоступны.</p>`}
            </div>
          </div>
        `;

        contentEl.querySelectorAll("[data-open-instruction]").forEach((button) => {
          button.onclick = () => window.open(`${apiBase}${button.dataset.openInstruction}`, "_blank");
        });
      }

      async function openChat(requestId) {
        state.activeChatRequestId = requestId;
        chatCard.classList.remove("hidden");
        document.body.classList.add("no-scroll");
        chatTitle.textContent = `Заявка #${requestId}`;
        await refreshChatMessages(true);
        startChatPolling();
      }

      async function sendChatMessage() {
        if (!state.activeChatRequestId) return;
        const text = chatInput.value.trim();
        if (!text) return;
        await api(`/api/requests/${state.activeChatRequestId}/messages`, {
          method: "POST",
          body: { text }
        });
        chatInput.value = "";
        await refreshChatMessages(true);
      }

      async function refreshChatMessages(forceScrollToBottom = false) {
        if (!state.activeChatRequestId) return;
        const nearBottom =
          chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 40;
        const payload = await api(`/api/requests/${state.activeChatRequestId}/messages`);
        if (payload.request?.status) {
          const cls = statusChipClass(payload.request.status);
          chatStatus.className = `status-chip ${cls}`;
          chatStatus.textContent = statusLabel(payload.request.status);
        }
        const currentRole = state.bootstrap?.role || "USER";

        chatMessages.innerHTML =
          payload.messages
            .map((message) => {
              const outgoing =
                (currentRole === "ADMIN" && message.senderRole === "ADMIN") ||
                (currentRole !== "ADMIN" && message.senderRole === "USER");
              const rowClass = outgoing ? "outgoing" : "incoming";
              const avatar = outgoing ? "" : `<span class="chat-avatar">AS</span>`;
              return `
                <div class="chat-msg-row ${rowClass}">
                  ${avatar}
                  <div class="chat-msg ${rowClass}">
                    <div>${escapeHtml(message.text)}</div>
                    <div class="muted">${formatDate(message.createdAt)}</div>
                  </div>
                </div>
              `;
            })
            .join("") || `<p class="muted">Сообщений пока нет.</p>`;

        if (forceScrollToBottom || nearBottom) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      function startChatPolling() {
        stopChatPolling();
        state.chatPollTimer = setInterval(() => {
          refreshChatMessages(false).catch(() => {});
        }, 2500);
      }

      function stopChatPolling() {
        if (!state.chatPollTimer) return;
        clearInterval(state.chatPollTimer);
        state.chatPollTimer = null;
      }

      async function loadBootstrap() {
        if (!telegramId) {
          whoamiEl.textContent = "Не найден Telegram ID. Откройте Mini App внутри Telegram.";
          setStatus("Ошибка авторизации Mini App.");
          return;
        }
        const payload = await api(`/api/bootstrap?telegramId=${telegramId}`);
        state.bootstrap = payload;
        const profileName =
          payload.user?.fullName || payload.user?.username || String(payload.user?.telegramId || "");
        whoamiEl.textContent = payload.registered
          ? profileName
          : "Пользователь не зарегистрирован";
        roleBadgeEl.textContent = payload.role || "guest";
        profileDotEl.textContent = profileName ? profileName.trim().charAt(0).toUpperCase() : "A";

        registerCard.classList.toggle("hidden", payload.registered);
        mainCard.classList.toggle("hidden", !payload.registered);
        tabsEl.classList.toggle("hidden", !payload.registered);
        if (!payload.registered) return;
        renderApp();
      }

      function renderApp() {
        if (!state.bootstrap?.registered) return;
        if (state.bootstrap.role === "ADMIN") {
          renderAdminView();
        } else {
          renderUserView();
        }
      }

      document.getElementById("register-btn").onclick = async () => {
        const fullName = document.getElementById("reg-name").value.trim();
        const organization = document.getElementById("reg-org").value.trim();
        if (!fullName || !organization) return setStatus("Заполните ФИО и организацию.");

        await api("/api/register", {
          method: "POST",
          body: {
            telegramId,
            fullName,
            organization,
            username: tgUser?.username || null,
            firstName: tgUser?.first_name || null,
            lastName: tgUser?.last_name || null
          }
        });

        state.activeTab = "";
        setStatus("Регистрация выполнена.");
        await loadBootstrap();
      };

      themeToggleEl.onclick = () => {
        const current = document.documentElement.getAttribute("data-theme") || "dark";
        const next = current === "dark" ? "light" : "dark";
        localStorage.setItem(THEME_STORAGE_KEY, next);
        applyTheme(next);
      };

      chatSendEl.onclick = () => sendChatMessage();
      chatBackEl.onclick = () => {
        stopChatPolling();
        state.activeChatRequestId = null;
        chatCard.classList.add("hidden");
        document.body.classList.remove("no-scroll");
      };
      chatAttachEl.onclick = () => {
        setStatus("Вложения будут добавлены на следующем этапе.");
      };

      chatInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          sendChatMessage();
        }
      });

      initTheme();
      loadBootstrap().catch((error) => {
        whoamiEl.textContent = "Ошибка загрузки данных";
        setStatus(error.message);
      });
    </script>
  </body>
</html>
